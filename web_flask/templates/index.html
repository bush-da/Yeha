<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeha - Home</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}">
    <style>
        .filter-btn.selected {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <a href="{{ url_for('home.index') }}">Yeha</a>
        </div>
        <nav class="nav-links">
            <a href="{{ url_for('home.index') }}" class="active">Home</a>
            <a href="{{ url_for('about.about') }}">About</a>
            {% if session.get('user_id') %}
                <a href="{{ url_for('profile.profile', user_id=session['user_id']) }}" class="profile-btn">Profile</a>
                <a href="{{ url_for('auth.logout') }}" class="logout">Logout</a>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="sign-in">Sign In</a>
            {% endif %}
        </nav>
    </header>

    <main>
        <section class="content">
            {% for post in posts %}
           <article class="blog-post">
                <div class="post-header">
		  <a href="/profile/{{ post.author_id }}">
		  <img src="{{ url_for('static', filename='images/' + (post.author.profile_picture if post.author.profile_picture else 'user.png')) }}" alt="Author's profile picture" class="profile-pic">
                  <div class="author-info">
                        <h3 class="author-name">{{ post.author.username }}</h3></a>
                        <p class="author-bio">{{ post.author.bio }}</p>
                        {% if session.get('user_id') and session.get('user_id') != post.author.id %}
                        <form action="{{ url_for('follow.follow_user', user_id=post.author.id) }}" method="POST">
                            <button type="submit" class="follow-btn">Follow</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <h2>{{ post.title }}</h2>

		{% for content in post.contents %}
		    {% if content.file_url %}
		        <img src="{{ content.file_url }}" alt="Post image">
		    {% else %}
		<p>{{ content.content | truncate(100) }}<span class="dots">....</span></p>
		    {% endif %}
		{% endfor %}

                <a href="{{ url_for('post.post_detail', post_id=post.id) }}" class="more-btn">More</a>
                <div class="post-actions">
                    <form action="{{ url_for('like.like_post', post_id=post.id) }}" method="POST">
                        <button type="submit" class="like-btn">
                            <img src="{{ url_for('static', filename='images/like.png') }}" alt="Like" class="action-icon">
                        </button>
                    </form>

                    <button class="comment-btn" onclick="toggleCommentBox('{{ post.id }}')">
                        <img src="{{ url_for('static', filename='images/comment.png') }}" alt="Comment" class="action-icon">
                    </button>
                    <button class="share-btn">
                        <img src="{{ url_for('static', filename='images/share.png') }}" alt="Share" class="action-icon">
                    </button>
                </div>
                <div class="comment-box" id="comment-box-{{ post.id }}" style="display:none;">
                    <textarea id="comment-text-{{ post.id }}" rows="3" placeholder="Add a comment..."></textarea>
                    <button onclick="submitComment('{{ post.id }}')">Comment</button>
                </div>
                <div class="tag">
                    {% for tag in post.tags %}
                        <span>#{{ tag.name }}</span>
                    {% endfor %}
                </div>
            </article>

            {% endfor %}
        </section>

        <aside class="sidebar">
            <h3>Filter by Tag</h3>
            <div class="tags">
	      <button class="filter-btn" onclick="resetFilters()">List All</button>
                {% for tag in tags %}
                    <button class="filter-btn" onclick="toggleTag('{{ tag.id }}')">#{{ tag.name }}</button>
                {% endfor %}

            </div>

        </aside>
    </main>

    <script>
        const selectedTags = new Set();

        function toggleTag(tagId) {
            const button = document.querySelector(`button[onclick="toggleTag('${tagId}')"]`);
            if (selectedTags.has(tagId)) {
                selectedTags.delete(tagId);
                button.classList.remove('selected');
            } else {
                selectedTags.add(tagId);
                button.classList.add('selected');
            }
            filterPosts();
        }

        function resetFilters() {
            selectedTags.clear();
            document.querySelectorAll('.filter-btn.selected').forEach(btn => btn.classList.remove('selected'));
            window.location.href = "{{ url_for('home.index') }}";
        }

        function filterPosts() {
            if (selectedTags.size > 0) {
                const tagParams = Array.from(selectedTags).join(',');
                window.location.href = `{{ url_for('home.index') }}?tags=${tagParams}`;
            } else {
                resetFilters();
            }
        }

        function toggleCommentBox(postId) {
            var commentBox = document.getElementById('comment-box-' + postId);
            commentBox.style.display = commentBox.style.display === 'none' ? 'block' : 'none';
        }

        function submitComment(postId) {
            var commentText = document.getElementById('comment-text-' + postId).value;
            console.log('Submitting comment:', commentText);
        }
    </script>
</body>
</html>
